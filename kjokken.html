<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>Kjøkken Kontrollpanel - Pro</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-950 text-slate-100 p-4 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const SUPABASE_URL = 'https://kirklktgeuqvkxhfibth.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_btB05RbKic_mG3lPpQ7jpw_NOkma2bE'; 
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const OrderCard = ({ order, onStart, onFinish }) => {
            const [timeLeft, setTimeLeft] = useState(null);
            const [statusColor, setStatusColor] = useState("text-slate-400");

            useEffect(() => {
                if (!order.started_at || !order.estimated_minutes) return;

                const interval = setInterval(() => {
                    const start = new Date(order.started_at).getTime();
                    const durationMs = order.estimated_minutes * 60 * 1000;
                    const now = new Date().getTime();
                    
                    const diff = (start + durationMs) - now;
                    const minutes = Math.floor(diff / 60000);
                    const seconds = Math.abs(Math.floor((diff % 60000) / 1000));
                    
                    setTimeLeft({ min: minutes, sec: seconds, isOver: diff < 0 });

                    // Fargelogikk
                    if (diff < 0) setStatusColor("text-red-500 animate-pulse");
                    else if (minutes < 1) setStatusColor("text-red-500");
                    else if (minutes < 6) setStatusColor("text-orange-500");
                    else setStatusColor("text-emerald-500");
                }, 1000);

                return () => clearInterval(interval);
            }, [order]);

            return (
                <div className="bg-slate-900 rounded-[2rem] border border-slate-800 p-6 shadow-2xl mb-4">
                    <div className="flex justify-between items-center mb-4">
                        <span className="bg-white text-black px-4 py-1 rounded-full font-black">BORD {order.table_number}</span>
                        {timeLeft && (
                            <div className={`text-3xl font-mono font-bold ${statusColor}`}>
                                {timeLeft.isOver ? "+" : ""}{Math.abs(timeLeft.min)}:{timeLeft.sec.toString().padStart(2, '0')}
                            </div>
                        )}
                    </div>

                    <h2 className="text-2xl font-bold mb-6">{order.items}</h2>

                    {!order.started_at ? (
                        <div className="grid grid-cols-4 gap-2">
                            {[5, 10, 15, 20].map(min => (
                                <button 
                                    key={min}
                                    onClick={() => onStart(order.id, min)}
                                    className="bg-slate-800 hover:bg-emerald-600 p-3 rounded-xl font-bold transition-all"
                                >
                                    {min}m
                                </button>
                            ))}
                        </div>
                    ) : (
                        <button 
                            onClick={() => onFinish(order.id)}
                            className="w-full bg-emerald-600 hover:bg-emerald-500 py-4 rounded-2xl font-black text-xl"
                        >
                            FERDIG / LEVERT
                        </button>
                    )}
                </div>
            );
        };

        function KitchenApp() {
            const [orders, setOrders] = useState([]);

            const loadOrders = async () => {
                const { data } = await supabaseClient
                    .from('orders')
                    .select('*')
                    .neq('status', 'ferdig')
                    .order('created_at', { ascending: true }); // Kronologisk
                setOrders(data || []);
            };

            const startOrder = async (id, minutes) => {
                await supabaseClient.from('orders').update({ 
                    status: 'behandles', 
                    estimated_minutes: minutes,
                    started_at: new Date().toISOString()
                }).eq('id', id);
            };

            const finishOrder = async (id) => {
                await supabaseClient.from('orders').update({ status: 'ferdig' }).eq('id', id);
            };

            useEffect(() => {
                loadOrders();
                const sub = supabaseClient.channel('k').on('postgres_changes', {event:'*', schema:'public', table:'orders'}, loadOrders).subscribe();
                return () => supabaseClient.removeChannel(sub);
            }, []);

            return (
                <div className="max-w-4xl mx-auto">
                    <h1 className="text-3xl font-black mb-8 italic">KJØKKEN<span className="text-emerald-500">PRO</span></h1>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {orders.map(o => (
                            <OrderCard key={o.id} order={o} onStart={startOrder} onFinish={finishOrder} />
                        ))}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<KitchenApp />);
    </script>
</body>
</html>
