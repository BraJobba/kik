<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>Kjøkken PRO</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-[#020617] text-slate-100 p-4 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const SUPABASE_URL = 'https://kirklktgeuqvkxhfibth.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_btB05RbKic_mG3lPpQ7jpw_NOkma2bE'; 
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const OrderCard = ({ order, onStart, onFinish }) => {
            const [timerText, setTimerText] = useState("--:--");
            const [colorClass, setColorClass] = useState("text-slate-500");

            useEffect(() => {
                // Sikkerhetssjekk: Hvis vi mangler tidsdata, ikke start intervallet
                if (!order.started_at || !order.estimated_minutes) return;

                const interval = setInterval(() => {
                    try {
                        const start = new Date(order.started_at).getTime();
                        const limit = parseInt(order.estimated_minutes) * 60000;
                        const now = new Date().getTime();
                        const diff = (start + limit) - now;
                        
                        const isOver = diff < 0;
                        const absDiff = Math.abs(diff);
                        const min = Math.floor(absDiff / 60000);
                        const sec = Math.floor((absDiff % 60000) / 1000);
                        
                        setTimerText(`${isOver ? '+' : ''}${min}:${sec.toString().padStart(2, '0')}`);
                        
                        if (isOver) setColorClass("text-red-500 animate-pulse font-black");
                        else if (min < 5) setColorClass("text-orange-500 font-bold");
                        else setColorClass("text-emerald-500 font-bold");
                    } catch (e) {
                        setTimerText("FEIL");
                    }
                }, 1000);

                return () => clearInterval(interval);
            }, [order.started_at, order.estimated_minutes]);

            return (
                <div className="bg-slate-900/80 border border-slate-800 p-6 rounded-[2.5rem] shadow-2xl">
                    <div className="flex justify-between items-center mb-6">
                        <span className="bg-white text-black px-4 py-1 rounded-full font-black text-xs uppercase">Bord {order.table_number}</span>
                        <span className={`text-4xl font-mono ${colorClass}`}>{timerText}</span>
                    </div>
                    
                    <h2 className="text-2xl font-bold text-white mb-8 leading-tight">{order.items}</h2>

                    {!order.started_at ? (
                        <div className="grid grid-cols-4 gap-2">
                            {[5, 10, 15, 20].map(m => (
                                <button key={m} onClick={() => onStart(order.id, m)} className="bg-slate-800 hover:bg-emerald-600 py-3 rounded-xl font-bold transition-all text-sm">{m}m</button>
                            ))}
                        </div>
                    ) : (
                        <button onClick={() => onFinish(order.id)} className="w-full bg-emerald-600 hover:bg-emerald-500 py-4 rounded-2xl font-black text-lg transition-all shadow-lg shadow-emerald-900/20">MARKER SOM FERDIG</button>
                    )}
                </div>
            );
        };

        function KitchenApp() {
            const [orders, setOrders] = useState([]);

            const load = async () => {
                const { data, error } = await supabaseClient
                    .from('orders')
                    .select('*')
                    .neq('status', 'ferdig')
                    .order('id', { ascending: true });
                
                if (!error) setOrders(data || []);
            };

            useEffect(() => {
                load();
                const ch = supabaseClient.channel('k').on('postgres_changes', {event:'*', schema:'public', table:'orders'}, load).subscribe();
                return () => supabaseClient.removeChannel(ch);
            }, []);

            const start = async (id, min) => {
                await supabaseClient.from('orders').update({ 
                    status: 'behandles', 
                    estimated_minutes: min, 
                    started_at: new Date().toISOString() 
                }).eq('id', id);
            };

            const finish = async (id) => {
                await supabaseClient.from('orders').update({ status: 'ferdig' }).eq('id', id);
            };

            return (
                <div className="max-w-6xl mx-auto py-10 px-6">
                    <header className="flex justify-between items-end mb-12 border-b border-slate-800 pb-8">
                        <div>
                            <h1 className="text-5xl font-black italic tracking-tighter">KJØKKEN<span className="text-emerald-500">PRO</span></h1>
                            <p className="text-slate-500 mt-2 font-medium uppercase tracking-widest text-xs">Live Kitchen Management System</p>
                        </div>
                        <div className="text-right">
                            <span className="text-4xl font-mono font-black text-emerald-500">{orders.length}</span>
                            <p className="text-slate-600 text-[10px] uppercase font-bold tracking-widest">Aktive Bestillinger</p>
                        </div>
                    </header>
                    
                    {orders.length === 0 ? (
                        <div className="text-center py-20 bg-slate-900/30 rounded-[3rem] border-2 border-dashed border-slate-800">
                            <p className="text-slate-600 text-xl font-medium italic">Ingen aktive bestillinger akkurat nå...</p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            {orders.map(o => <OrderCard key={o.id} order={o} onStart={start} onFinish={finish} />)}
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<KitchenApp />);
    </script>
</body>
</html>
