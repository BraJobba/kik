<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Meny & Bestilling</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-950 text-slate-100 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const SUPABASE_URL = 'https://kirklktgeuqvkxhfibth.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_btB05RbKic_mG3lPpQ7jpw_NOkma2bE'; 
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const MENY = [
            { id: 1, navn: "Tr√∏ffelpasta", pris: 249, beskrivelse: "Fersk pasta med kremet tr√∏ffelsaus." },
            { id: 2, navn: "Margherita Pizza", pris: 189, beskrivelse: "Tomat, mozzarella og fersk basilikum." },
            { id: 3, navn: "Klassisk Burger", pris: 215, beskrivelse: "180g storfekj√∏tt med brioche-br√∏d." },
            { id: 4, navn: "Mineralvann", pris: 45, beskrivelse: "Valgfri brus 0.33l." }
        ];

        function GuestApp() {
            const [cart, setCart] = useState([]);
            const [tableNumber, setTableNumber] = useState("");
            const [lastOrderId, setLastOrderId] = useState(null);
            const [liveOrder, setLiveOrder] = useState(null);
            const [displayTime, setDisplayTime] = useState("");

            // 1. LYTT P√Ö OPPDATERINGER FRA DATABASEN
            useEffect(() => {
                if (!lastOrderId) return;

                const fetchOrder = async () => {
                    const { data } = await supabaseClient.from('orders').select('*').eq('id', lastOrderId).single();
                    setLiveOrder(data);
                };

                fetchOrder();

                const sub = supabaseClient
                    .channel('status')
                    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'orders', filter: `id=eq.${lastOrderId}` }, 
                    payload => setLiveOrder(payload.new))
                    .subscribe();

                return () => supabaseClient.removeChannel(sub);
            }, [lastOrderId]);

            // 2. LIVE NEDTELLING FOR GJESTEN
            useEffect(() => {
                if (!liveOrder?.started_at || !liveOrder?.estimated_minutes) return;

                const interval = setInterval(() => {
                    const start = new Date(liveOrder.started_at).getTime();
                    const limit = liveOrder.estimated_minutes * 60000;
                    const now = new Date().getTime();
                    const diff = (start + limit) - now;
                    
                    const isOver = diff < 0;
                    const absDiff = Math.abs(diff);
                    const min = Math.floor(absDiff / 60000);
                    const sec = Math.floor((absDiff % 60000) / 1000);
                    
                    setDisplayTime(`${isOver ? 'Klar om et √∏yeblikk!' : min + ':' + sec.toString().padStart(2, '0')}`);
                }, 1000);

                return () => clearInterval(interval);
            }, [liveOrder]);

            const sendOrder = async () => {
                if (!tableNumber) return alert("Skriv bordnummer!");
                const { data } = await supabaseClient.from('orders').insert([{ 
                    table_number: parseInt(tableNumber), 
                    items: cart.map(i => i.navn).join(", "), 
                    status: 'ny' 
                }]).select();
                setLastOrderId(data[0].id);
                setCart([]);
            };

            return (
                <div className="max-w-md mx-auto p-6 pb-32">
                    <header className="py-8 text-center">
                        <h1 className="text-3xl font-black italic">DIGITAL<span className="text-emerald-500">MENY</span></h1>
                        <input type="number" placeholder="Bord" className="mt-4 bg-slate-900 border border-slate-800 rounded-xl px-4 py-2 text-center w-24" value={tableNumber} onChange={e => setTableNumber(e.target.value)} />
                    </header>

                    {liveOrder && (
                        <div className="mb-8 bg-emerald-950/30 border border-emerald-500/50 p-6 rounded-[2rem] text-center shadow-2xl">
                            <h3 className="text-xs uppercase tracking-widest text-emerald-500 font-bold mb-2">Status</h3>
                            {liveOrder.status === 'ny' && <p className="animate-pulse">Venter p√• bekreftelse...</p>}
                            {liveOrder.status === 'behandles' && (
                                <div>
                                    <p className="text-lg font-bold">Kj√∏kkenet lager maten din! üë®‚Äçüç≥</p>
                                    <p className="text-4xl font-black mt-3 text-white font-mono">{displayTime}</p>
                                </div>
                            )}
                            {liveOrder.status === 'ferdig' && <p className="text-xl font-bold text-white italic underline">Maten er servert! Velbekomme! üçΩÔ∏è</p>}
                        </div>
                    )}

                    <div className="space-y-4">
                        {MENY.map(item => (
                            <div key={item.id} className="bg-slate-900 p-5 rounded-3xl border border-slate-800 flex justify-between items-center shadow-lg">
                                <div>
                                    <h3 className="font-bold text-white">{item.navn}</h3>
                                    <p className="text-emerald-500 font-bold">{item.pris},-</p>
                                </div>
                                <button onClick={() => setCart([...cart, item])} className="bg-emerald-600 p-3 rounded-2xl">+</button>
                            </div>
                        ))}
                    </div>

                    {cart.length > 0 && !liveOrder && (
                        <div className="fixed bottom-6 left-6 right-6">
                            <button onClick={sendOrder} className="w-full bg-emerald-600 py-5 rounded-3xl font-black shadow-2xl">BESTILL {cart.length} RETTER</button>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GuestApp />);
    </script>
</body>
</html>
